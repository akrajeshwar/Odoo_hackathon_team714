<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Register - Ticket Platform</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body class="auth-page">
    <div class="auth-container">
        <div class="auth-card">
            <div class="auth-header">
                <h1>ðŸŽ« Ticket Platform</h1>
                <p>Create your account</p>
            </div>

            <form id="registerForm" class="auth-form">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" name="username" required minlength="3">
                    <div class="field-hint">At least 3 characters, letters, numbers, _ and - only</div>
                    <div class="error-message" id="usernameError"></div>
                    <div class="success-message" id="usernameSuccess"></div>
                </div>

                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" name="email" required>
                    <div class="error-message" id="emailError"></div>
                    <div class="success-message" id="emailSuccess"></div>
                </div>

                <div class="form-group">
                    <label for="role">Account Type</label>
                    <select id="role" name="role" required>
                        <option value="">Select account type</option>
                        <option value="user">User (Can create tickets)</option>
                        <option value="agent">Agent (Can manage tickets)</option>
                    </select>
                    <div class="error-message" id="roleError"></div>
                </div>

                <div class="form-group">
                    <label for="password">Password</label>
                    <input type="password" id="password" name="password" required minlength="6">
                    <div class="field-hint">At least 6 characters with letters and numbers</div>
                    <div class="error-message" id="passwordError"></div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirm Password</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required>
                    <div class="error-message" id="confirmPasswordError"></div>
                    <div class="success-message" id="confirmPasswordSuccess"></div>
                </div>

                <button type="submit" class="btn-primary" id="registerBtn">
                    <span class="btn-text">Create Account</span>
                    <div class="btn-loading" id="registerLoading">Creating account...</div>
                </button>

                <div class="error-message" id="generalError"></div>
            </form>

            <div class="auth-footer">
                <p>Already have an account? <a href="/">Sign in here</a></p>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        // Registration form handling
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('registerForm');
            const usernameInput = document.getElementById('username');
            const emailInput = document.getElementById('email');
            const passwordInput = document.getElementById('password');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const registerBtn = document.getElementById('registerBtn');

            // Real-time validation
            let validationTimeout;

            usernameInput.addEventListener('input', function() {
                clearTimeout(validationTimeout);
                validationTimeout = setTimeout(() => checkUsername(this.value), 500);
            });

            emailInput.addEventListener('input', function() {
                clearTimeout(validationTimeout);
                validationTimeout = setTimeout(() => checkEmail(this.value), 500);
            });

            passwordInput.addEventListener('input', validatePassword);
            confirmPasswordInput.addEventListener('input', validateConfirmPassword);

            // Check username availability
            async function checkUsername(username) {
                const errorEl = document.getElementById('usernameError');
                const successEl = document.getElementById('usernameSuccess');
                
                errorEl.textContent = '';
                successEl.textContent = '';

                if (username.length < 3) return;

                try {
                    const response = await api.get(`/auth/check-username/${username}`);
                    if (response.data.available) {
                        successEl.textContent = 'âœ“ Username is available';
                    } else {
                        errorEl.textContent = 'Username is already taken';
                    }
                } catch (error) {
                    console.error('Username check error:', error);
                }
            }

            // Check email availability
            async function checkEmail(email) {
                const errorEl = document.getElementById('emailError');
                const successEl = document.getElementById('emailSuccess');
                
                errorEl.textContent = '';
                successEl.textContent = '';

                if (!email.includes('@')) return;

                try {
                    const response = await api.get(`/auth/check-email/${email}`);
                    if (response.data.available) {
                        successEl.textContent = 'âœ“ Email is available';
                    } else {
                        errorEl.textContent = 'Email is already registered';
                    }
                } catch (error) {
                    console.error('Email check error:', error);
                }
            }

            // Validate password
            function validatePassword() {
                const password = passwordInput.value;
                const errorEl = document.getElementById('passwordError');
                
                errorEl.textContent = '';

                if (password.length === 0) return;

                if (password.length < 6) {
                    errorEl.textContent = 'Password must be at least 6 characters long';
                    return;
                }

                const hasLetter = /[a-zA-Z]/.test(password);
                const hasNumber = /\d/.test(password);

                if (!hasLetter || !hasNumber) {
                    errorEl.textContent = 'Password must contain at least one letter and one number';
                    return;
                }

                validateConfirmPassword();
            }

            // Validate confirm password
            function validateConfirmPassword() {
                const password = passwordInput.value;
                const confirmPassword = confirmPasswordInput.value;
                const errorEl = document.getElementById('confirmPasswordError');
                const successEl = document.getElementById('confirmPasswordSuccess');
                
                errorEl.textContent = '';
                successEl.textContent = '';

                if (confirmPassword.length === 0) return;

                if (password !== confirmPassword) {
                    errorEl.textContent = 'Passwords do not match';
                } else {
                    successEl.textContent = 'âœ“ Passwords match';
                }
            }

            // Form submission
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const formData = new FormData(form);
                const data = Object.fromEntries(formData);
                
                // Clear previous errors
                document.querySelectorAll('.error-message').forEach(el => el.textContent = '');
                
                // Show loading state
                registerBtn.classList.add('loading');
                
                try {
                    const response = await api.post('/auth/register', data);
                    
                    if (response.success) {
                        // Store token and redirect
                        localStorage.setItem('token', response.data.token);
                        localStorage.setItem('user', JSON.stringify(response.data.user));
                        
                        // Redirect to dashboard
                        window.location.href = '/dashboard';
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    
                    if (error.errors && Array.isArray(error.errors)) {
                        // Show specific field errors
                        error.errors.forEach(errorMsg => {
                            if (errorMsg.includes('Username')) {
                                document.getElementById('usernameError').textContent = errorMsg;
                            } else if (errorMsg.includes('Email')) {
                                document.getElementById('emailError').textContent = errorMsg;
                            } else if (errorMsg.includes('Password')) {
                                document.getElementById('passwordError').textContent = errorMsg;
                            } else if (errorMsg.includes('Role')) {
                                document.getElementById('roleError').textContent = errorMsg;
                            } else {
                                document.getElementById('generalError').textContent = errorMsg;
                            }
                        });
                    } else {
                        document.getElementById('generalError').textContent = error.message || 'Registration failed. Please try again.';
                    }
                } finally {
                    registerBtn.classList.remove('loading');
                }
            });
        });
    </script>
</body>
</html>